<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Week 5 Picks</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background-color: #1c1c1c; color: white; font-family: Arial, sans-serif; }
  .container { max-width: 900px; }

  .game-block {
    background: #282828;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }

  .teams-container {
    display: flex;
    justify-content: space-between;
    flex-wrap: nowrap; /* always side by side */
    margin-top: 10px;
  }

  .btn-team {
    width: calc(50% - 5px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    height: 120px;
    border-radius: 12px;
    border: 2px solid white;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.15s;
  }

  .btn-team:hover { transform: scale(1.03); }

  .btn-team.active {
    outline: 2px solid gold;
    box-shadow: 0 0 10px gold;
  }

  .team-logo { max-width: 70px; max-height: 70px; object-fit: contain; margin-bottom: 5px; }

  .odds { font-size: 0.8rem; color: #ffd700; margin-top: 3px; }

  .pickers { margin-top: 5px; font-size: 0.75rem; color: #00ffff; text-align: center; }

  .vs-span { align-self: center; font-weight: bold; margin: 0 10px; }
</style>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container my-3">
  <a href="Week5Homepage.html" class="btn btn-light btn-sm text-dark mb-3">Home</a>
  <h2 id="welcomeMessage">Welcome!</h2>

  <div class="mb-3">
    <button id="googleSignInBtn" class="btn btn-light text-dark mb-2">Sign in with Google</button>
    <button id="googleSignOutBtn" class="btn btn-secondary mb-2" style="display:none;">Sign Out</button>
    <p id="authStatus">Not signed in</p>
  </div>

  <form id="Week5picksform">
    <div id="week5games"></div>
    <button class="btn btn-secondary text-white mt-3" type="submit">Save Picks</button>
  </form>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAkSlyFKQNHYQgLa_dQuzjYSzXSISoCWKU",
  authDomain: "college-football-pickem-68eed.firebaseapp.com",
  projectId: "college-football-pickem-68eed",
  storageBucket: "college-football-pickem-68eed.appspot.com",
  messagingSenderId: "650202039805",
  appId: "1:650202039805:web:70e51177aab22e4d614594"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const provider = new firebase.auth.GoogleAuthProvider();

const userSelections = {};
let currentUser = null;
let picksInitialized = false;

// Utility functions
function getContrastYIQ(hexcolor) {
  hexcolor = hexcolor.replace('#','');
  const r = parseInt(hexcolor.substr(0,2),16);
  const g = parseInt(hexcolor.substr(2,2),16);
  const b = parseInt(hexcolor.substr(4,2),16);
  const yiq = ((r*299)+(g*587)+(b*114))/1000;
  return (yiq >= 128) ? 'black' : 'white';
}

function adjustColor(color, amount) {
  let usePound = false;
  if (color[0] === "#") { color = color.slice(1); usePound = true; }
  let num = parseInt(color,16);
  let r = (num >> 16) + amount; r = Math.min(255, Math.max(0, r));
  let g = ((num >> 8) & 0x00FF) + amount; g = Math.min(255, Math.max(0, g));
  let b = (num & 0x0000FF) + amount; b = Math.min(255, Math.max(0, b));
  return (usePound ? "#" : "") + (r << 16 | g << 8 | b).toString(16).padStart(6,'0');
}

// Save picks
function savePicks(user, weekNum) {
  const form = document.getElementById('Week5picksform');
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const docId = `${user.uid}_week${weekNum}`;
    const dbName = `week${weekNum}Picks`;
    await db.collection(dbName).doc(docId).set({
      uid: user.uid,
      name: user.displayName,
      week: weekNum,
      picks: userSelections,
      timestamp: new Date()
    });
    alert("Picks saved successfully!");
  });
}

// Load previous picks
async function loadUserPicks(user, weekNum) {
  const docId = `${user.uid}_week${weekNum}`;
  const dbName = `week${weekNum}Picks`;
  const docRef = await db.collection(dbName).doc(docId).get();
  if (!docRef.exists) return;

  const picks = docRef.data().picks || {};
  Object.entries(picks).forEach(([eventId, pickedTeamId]) => {
    const btnGroup = document.querySelector(`div[data-event-id="${eventId}"]`);
    if (!btnGroup) return;
    const matchBtn = Array.from(btnGroup.querySelectorAll('.btn-team'))
      .find(b => b.dataset.teamId === pickedTeamId);
    if (matchBtn) matchBtn.classList.add('active');
    userSelections[eventId] = pickedTeamId;
  });
}

// Load games and render buttons
async function loadGames(weekNum, user) {
  const container = document.getElementById('week5games');
  container.innerHTML = '<p>Loading games...</p>';

  try {
    const res = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=20250924-20250927');
    const data = await res.json();
    const targetEventIds = ["401754543","401752850","401752717","401752719","401752724","401752853","401756904","401752854","401752718"];
    const gameSlate = data.events.filter(event => targetEventIds.includes(event.id));

    container.innerHTML = '';
    for (const event of gameSlate) {
      const comp = event.competitions[0];
      const home = comp.competitors[0].team;
      const away = comp.competitors[1].team;
      const kickoffTime = new Date(event.date);

      // Game block
      const gameDiv = document.createElement('div');
      gameDiv.className = 'game-block';
      const header = document.createElement('div');
      header.innerHTML = `<strong>${home.location} vs ${away.location}</strong> <small>${event.status.type.description} | ${kickoffTime.toLocaleString()}</small>`;
      gameDiv.appendChild(header);

      // Teams container
      const teamsDiv = document.createElement('div');
      teamsDiv.className = 'teams-container';
      teamsDiv.dataset.eventId = event.id;

      const oddsInfo = comp.odds && comp.odds[0];
      let homeFav = false, awayFav = false;
      if (oddsInfo && oddsInfo.homeTeamOdds) {
        homeFav = oddsInfo.homeTeamOdds.favorite;
        awayFav = !homeFav;
      }

      [home, away].forEach((team, index) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-team';
        btn.dataset.teamId = team.id;
        btn.dataset.eventId = event.id;

        const bgColor = `#${adjustColor(team.color, 40)}`;
        btn.style.backgroundColor = bgColor;
        btn.style.color = getContrastYIQ(bgColor);

        // Logo + Name
        const img = document.createElement('img');
        img.src = team.logo; img.className = 'team-logo'; btn.appendChild(img);

        const nameSpan = document.createElement('span'); nameSpan.textContent = team.location; btn.appendChild(nameSpan);

        // Odds for favored team
        if ((team === home && homeFav) || (team === away && awayFav)) {
          const oddsSpan = document.createElement('div');
          oddsSpan.className = 'odds';
          oddsSpan.textContent = oddsInfo.details || 'Favored';
          btn.appendChild(oddsSpan);
        }

        // Pickers display
        const pickersDiv = document.createElement('div'); pickersDiv.className = 'pickers';
        pickersDiv.dataset.teamId = team.id;
        btn.appendChild(pickersDiv);

        // Disable past games
        if (new Date() >= kickoffTime) btn.disabled = true;
        else btn.onclick = () => {
          teamsDiv.querySelectorAll('.btn-team').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          userSelections[event.id] = btn.dataset.teamId;
        };

        teamsDiv.appendChild(btn);

        if (index === 0) {
          const vsSpan = document.createElement('div'); vsSpan.className = 'vs-span'; vsSpan.textContent = 'vs';
          teamsDiv.appendChild(vsSpan);
        }
      });

      gameDiv.appendChild(teamsDiv);
      container.appendChild(gameDiv);
    }

    if (user) await loadUserPicks(user, weekNum);

  } catch (err) { console.error(err); container.innerHTML = '<p>Error loading games</p>'; }
}

// Initialize picks
function initPicks(user) {
  if (picksInitialized) return;
  picksInitialized = true;
  const weekNum = 5;
  document.getElementById('welcomeMessage').innerText = `${user.displayName}'s Week ${weekNum} Picks`;
  savePicks(user, weekNum);
  loadGames(weekNum, user);
}

// Auth
document.getElementById("googleSignInBtn").onclick = () => auth.signInWithPopup(provider);
document.getElementById("googleSignOutBtn").onclick = () => {
  auth.signOut().then(() => {
    currentUser = null;
    picksInitialized = false;
    document.getElementById("authStatus").innerText = "Not signed in";
    document.getElementById("googleSignInBtn").style.display = "inline-block";
    document.getElementById("googleSignOutBtn").style.display = "none";
    document.getElementById('week5games').innerHTML = '';
    document.getElementById('welcomeMessage').innerText = '';
  });
};

auth.onAuthStateChanged(user => {
  if (user) { currentUser = user; initPicks(user); document.getElementById("authStatus").innerText = `Signed in as ${user.displayName}`;
    document.getElementById("googleSignInBtn").style.display = "none";
    document.getElementById("googleSignOutBtn").style.display = "inline-block";
  }
});
</script>
</body>
</html>

