<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBB Pick'em Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #00ff88; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        
        /* Auth & Profile Header */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .auth-box { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input { padding: 8px; margin-right: 5px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; }
        button { padding: 8px 15px; border-radius: 4px; border: none; background: var(--accent); color: black; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.8; }

        /* Game Cards */
        .game-card { background: var(--card); border-radius: 10px; padding: 20px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .team-btn { background: #333; color: white; border: 1px solid var(--accent); padding: 10px; width: 45%; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .team-btn:hover { background: var(--accent); color: black; }
        .status { font-size: 0.8em; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* Leaderboard */
        .leaderboard { margin-top: 40px; background: #1a1a1a; border-radius: 10px; padding: 15px; }
        .user-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üèÄ CBB Pick'em</h1>
        <div id="user-info">Not Logged In</div>
    </div>

    <div id="auth-ui" class="auth-box">
        <h3>Login / Sign Up</h3>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="handleAuth('signIn')">Login</button>
        <button onclick="handleAuth('signUp')" style="background: #555; color: white;">Sign Up</button>
    </div>

    <div id="slate-container">
        <h2>Today's Games</h2>
        <div id="games-list">Loading live scores...</div>
    </div>

    <div class="leaderboard">
        <h3>üèÜ Leaderboard</h3>
        <div id="leaderboard-list"></div>
    </div>
</div>



<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://uyrjamdudxudijijqrgv.supabase.co';
    const SUPABASE_KEY = 'your-anon-public-key-here'; // USE YOUR ANON KEY
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- AUTHENTICATION ---
    async function handleAuth(type) {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const { data, error } = (type === 'signUp') 
            ? await _supabase.auth.signUp({ email, password })
            : await _supabase.auth.signInWithPassword({ email, password });

        if (error) alert(error.message);
        else location.reload();
    }

    async function checkUser() {
        const { data: { user } } = await _supabase.auth.getUser();
        if (user) {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('user-info').innerText = `Hello, ${user.email}`;
            return user;
        }
        return null;
    }

    // --- LOAD DATA ---
    async function loadContent() {
        const user = await checkUser();
        
        // Load Games from your Rust-synced table
        const { data: games, error: gErr } = await _supabase.from('slate').select('*');
        if (games) renderGames(games, user);

        // Load Leaderboard
        const { data: profiles, error: pErr } = await _supabase
            .from('profiles')
            .select('username, total_points')
            .order('total_points', { ascending: false });
        if (profiles) renderLeaderboard(profiles);
    }

    // --- RENDERING ---
    function renderGames(games, user) {
        const list = document.getElementById('games-list');
        list.innerHTML = games.map(g => {
            // Split matchup (e.g. "Duke @ UNC")
            const teams = g.matchup.split(' vs ') || g.matchup.split(' @ ');
            return `
                <div class="game-card">
                    <button class="team-btn" onclick="makePick('${g.espn_id}', '${teams[0]}')">${teams[0]}</button>
                    <div style="text-align: center;">
                        <div class="status">${g.status}</div>
                        <div>${g.home_score} - ${g.away_score}</div>
                    </div>
                    <button class="team-btn" onclick="makePick('${g.espn_id}', '${teams[1]}')">${teams[1]}</button>
                </div>
            `;
        }).join('');
    }

    function renderLeaderboard(profiles) {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = profiles.map(p => `
            <div class="user-row">
                <span>${p.username || 'Anonymous'}</span>
                <span><strong>${p.total_points}</strong></span>
            </div>
        `).join('');
    }

    // --- SAVE PICK ---
    async function makePick(gameId, teamName) {
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) return alert("Please login to make picks!");

        const { error } = await _supabase.from('user_picks').upsert({
            user_id: user.id,
            espn_id: gameId,
            picked_team: teamName
        });

        if (error) alert("Error saving pick: " + error.message);
        else alert(`Locked in: ${teamName}`);
    }

    loadContent();
</script>
</body>
</html>
