<div id="leaderboardContainer"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAkSlyFKQNHYQgLa_dQuzjYSzXSISoCWKU",
    authDomain: "college-football-pickem-68eed.firebaseapp.com",
    projectId: "college-football-pickem-68eed",
    storageBucket: "college-football-pickem-68eed.appspot.com",
    messagingSenderId: "650202039805",
    appId: "1:650202039805:web:70e51177aab22e4d614594"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  document.body.style.backgroundColor = '#1c1c1c'; 
  document.body.style.color = 'white';
  document.body.style.fontFamily = 'Arial, sans-serif';

  async function loadLeaderboard(weekNum) {
    const container = document.getElementById('leaderboardContainer');
    container.innerHTML = '<p>Loading leaderboard...</p>';

    try {
      // 1️⃣ Fetch all user picks from Firestore
      const picksSnapshot = await db.collection(`week${weekNum}Picks`).get();
      const userData = [];

      picksSnapshot.forEach(doc => {
        const { name, picks } = doc.data();
        userData.push({ name, picks, wins: 0, losses: 0 });
      });

      if (userData.length === 0) {
        container.innerHTML = '<p>No picks yet for this week.</p>';
        return;
      }

      // 2️⃣ Fetch ESPN game results
      const res = await fetch('https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=20250906');
      const data = await res.json();

      // Only include events that are final
      const finalGames = data.events.filter(event => event.status.type.completed);

      // Create a map of eventId -> winning teamId
      const gameResults = {};
      finalGames.forEach(event => {
        const comp = event.competitions[0];
        const home = comp.competitors[0];
        const away = comp.competitors[1];

        // Skip games that aren’t final
        if (isNaN(home.score) || isNaN(away.score)) return;

        const winnerTeamId = home.score > away.score ? home.team.id : away.team.id;
        gameResults[event.id] = winnerTeamId;
      });

      // 3️⃣ Compare each user's picks with actual results
      userData.forEach(user => {
        for (const [eventId, teamId] of Object.entries(user.picks)) {
          if (gameResults[eventId] === undefined) continue; // ignore unfinished games
          if (teamId === gameResults[eventId]) user.wins += 1;
          else user.losses += 1;
        }
      });

      // 4️⃣ Sort leaderboard by wins descending
      userData.sort((a, b) => b.wins - a.wins);

      // 5️⃣ Render leaderboard
      container.innerHTML = '<h2>Week ' + weekNum + ' Leaderboard</h2>';
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      table.innerHTML = `
        <thead>
          <tr style="border-bottom:1px solid white;">
            <th style="text-align:left;padding:8px;">Rank</th>
            <th style="text-align:left;padding:8px;">Player</th>
            <th style="text-align:left;padding:8px;">Wins</th>
            <th style="text-align:left;padding:8px;">Losses</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;

      const tbody = table.querySelector('tbody');
      userData.forEach((user, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px;">${index + 1}</td>
          <td style="padding:8px;">${user.name}</td>
          <td style="padding:8px;">${user.wins}</td>
          <td style="padding:8px;">${user.losses}</td>
        `;
        tbody.appendChild(tr);
      });

      container.appendChild(table);

    } catch (err) {
      console.error('Error loading leaderboard:', err);
      container.innerHTML = '<p>Error loading leaderboard. Check console.</p>';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const weekNum = 2;
    loadLeaderboard(weekNum);

    // Optional: refresh every 30s
    // setInterval(() => loadLeaderboard(weekNum), 30000);
  });
</script>
