<div id="leaderboardContainer"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAkSlyFKQNHYQgLa_dQuzjYSzXSISoCWKU",
  authDomain: "college-football-pickem-68eed.firebaseapp.com",
  projectId: "college-football-pickem-68eed",
  storageBucket: "college-football-pickem-68eed.appspot.com",
  messagingSenderId: "650202039805",
  appId: "1:650202039805:web:70e51177aab22e4d614594"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

document.body.style.backgroundColor = '#1c1c1c';
document.body.style.color = 'white';
document.body.style.fontFamily = 'Arial, sans-serif';

async function loadLeaderboard(selectedWeekNum) {
  const container = document.getElementById('leaderboardContainer');
  container.innerHTML = '<p>Loading leaderboard...</p>';

  try {
    // 1️⃣ Fetch all week collections
    const weekCollections = await db.listCollections();
    const weekDocs = [];
    
    for (const col of weekCollections) {
      if (col.id.startsWith('week')) {
        const docs = await col.get();
        docs.forEach(d => weekDocs.push({ week: col.id, ...d.data() }));
      }
    }

    if (weekDocs.length === 0) {
      container.innerHTML = '<p>No picks yet.</p>';
      return;
    }

    // 2️⃣ Fetch all ESPN games needed
    const allDates = ['20250827','20250906']; // adjust for your weeks
    let allEvents = [];

    for (const date of allDates) {
      const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard?dates=${date}`);
      const data = await res.json();
      allEvents = allEvents.concat(data.events);
    }

    // Create a map: eventId -> {homeId, awayId, winnerTeamId, matchupString, completed}
    const eventMap = {};
    allEvents.forEach(event => {
      const comp = event.competitions[0];
      const home = comp.competitors[0];
      const away = comp.competitors[1];
      const completed = event.status.type.completed;
      const winnerId = completed ? (home.score > away.score ? home.team.id : away.team.id) : null;
      const matchupString = `${home.team.location} vs ${away.team.location}`;
      eventMap[event.id] = { winnerId, homeId: home.team.id, awayId: away.team.id, matchupString, completed };
    });

    // 3️⃣ Compute scores for each user
    const users = {};
    weekDocs.forEach(doc => {
      const userKey = doc.name;
      if (!users[userKey]) users[userKey] = { name: doc.name, totalWins: 0, totalLosses: 0, weekWins: {}, weekLosses: {} };
      
      for (const [pickKey, pickValue] of Object.entries(doc.picks)) {
        let eventData;
        let correct = false;

        // Detect old week 1 format
        if (pickKey.includes(' vs ')) {
          // old style, find eventId by matchupString
          eventData = Object.values(eventMap).find(ev => ev.matchupString === pickKey);
          if (!eventData || !eventData.completed) continue;
          if (pickValue === (eventData.winnerId === eventData.homeId ? eventData.homeId : eventData.awayId)) correct = true;
        } else {
          // new format
          eventData = eventMap[pickKey];
          if (!eventData || !eventData.completed) continue;
          if (pickValue === eventData.winnerId) correct = true;
        }

        // Update scores
        const weekNum = doc.week.replace('week','');
        if (!users[userKey].weekWins[weekNum]) users[userKey].weekWins[weekNum] = 0;
        if (!users[userKey].weekLosses[weekNum]) users[userKey].weekLosses[weekNum] = 0;

        if (correct) {
          users[userKey].totalWins += 1;
          users[userKey].weekWins[weekNum] += 1;
        } else {
          users[userKey].totalLosses += 1;
          users[userKey].weekLosses[weekNum] += 1;
        }
      }
    });

    // 4️⃣ Sort leaderboard
    const leaderboard = Object.values(users).sort((a,b)=>b.totalWins - a.totalWins);
    const weekLeaderboard = Object.values(users).sort((a,b)=>(b.weekWins[selectedWeekNum]||0) - (a.weekWins[selectedWeekNum]||0));

    // 5️⃣ Render
    container.innerHTML = `<h2>Week ${selectedWeekNum} Leaderboard</h2>`;
    renderTable(container, weekLeaderboard, selectedWeekNum, true);
    container.innerHTML += `<h2>Overall Leaderboard</h2>`;
    renderTable(container, leaderboard, selectedWeekNum, false);

  } catch (err) {
    console.error('Error loading leaderboard:', err);
    container.innerHTML = '<p>Error loading leaderboard.</p>';
  }
}

// Helper to render a table
function renderTable(container, data, weekNum, isWeek) {
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  table.style.marginBottom = '20px';

  table.innerHTML = `
    <thead>
      <tr style="border-bottom:1px solid white;">
        <th style="text-align:left;padding:8px;">Rank</th>
        <th style="text-align:left;padding:8px;">Player</th>
        <th style="text-align:left;padding:8px;">Wins</th>
        <th style="text-align:left;padding:8px;">Losses</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector('tbody');
  data.forEach((user, index)=>{
    const wins = isWeek ? (user.weekWins[weekNum]||0) : user.totalWins;
    const losses = isWeek ? (user.weekLosses[weekNum]||0) : user.totalLosses;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:8px;">${index+1}</td>
      <td style="padding:8px;">${user.name}</td>
      <td style="padding:8px;">${wins}</td>
      <td style="padding:8px;">${losses}</td>
    `;
    tbody.appendChild(tr);
  });

  container.appendChild(table);
}

document.addEventListener('DOMContentLoaded', ()=>{
  const selectedWeek = 2; // change to week you want
  loadLeaderboard(selectedWeek);
});
</script>

